<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Our Menu - Online Ordering</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .menu-item-card {
            transition: transform 0.3s;
            margin-bottom: 20px;
            height: 100%;
        }
        .menu-item-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        .menu-item-img {
            height: 200px;
            object-fit: cover;
        }
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-top: 10px;
        }
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            font-weight: bold;
        }
        .quantity-input {
            width: 50px;
            text-align: center;
            margin: 0 5px;
        }
        .cart-summary {
            position: sticky;
            top: 20px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div th:replace="fragments/header :: header"></div>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-8">
                <h1 class="mb-4">Our Menu</h1>
                <div class="row">
                    <div th:each="menuItem : ${menuItems}" class="col-md-6 col-lg-4">
                        <div class="card menu-item-card">
                            <img th:src="${menuItem.imageUrl}" class="card-img-top menu-item-img" 
                                 th:alt="${menuItem.name}" 
                                 th:src="${menuItem.imageUrl} ?: 'https://via.placeholder.com/300x200?text=No+Image'">
                            <div class="card-body">
                                <h5 class="card-title" th:text="${menuItem.name}"></h5>
                                <p class="card-text" th:text="${menuItem.description}"></p>
                                <p class="h5 text-primary" th:text="'$' + ${#numbers.formatDecimal(menuItem.price, 1, 2)}"></p>
                                
                                <div class="quantity-control">
                                    <button class="btn btn-sm quantity-btn minus" 
                                            onclick="updateQuantity('item_' + [[${menuItem.id}]], -1)">-</button>
                                    <input type="number" 
                                           class="form-control quantity-input" 
                                           th:id="'item_' + ${menuItem.id}" 
                                           name="item_[[${menuItem.id}]]" 
                                           value="0" min="0" max="20">
                                    <button class="btn btn-sm btn-primary quantity-btn plus" 
                                            onclick="updateQuantity('item_' + [[${menuItem.id}]], 1)">+</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="cart-summary">
                    <h3>Your Order</h3>
                    <div id="cart-items">
                        <p class="text-muted">Add items to your order</p>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between mb-3">
                        <h5>Total:</h5>
                        <h5 id="cart-total">$0.00</h5>
                    </div>
                    <div th:if="${param.error != null}" class="alert alert-danger mt-2" role="alert">
                        <span th:text="${param.error}"></span>
                    </div>
                    
                    <!-- Cart items will be populated here -->
                    <div id="cart-summary"></div>
                    
                    <!-- Checkout button -->
                    <button type="button" id="checkout-btn" class="btn btn-primary w-100" onclick="proceedToCheckout()" disabled>
                        Proceed to Checkout
                    </button>
                    
                    <!-- Hidden form for checkout -->
                    <form id="checkout-form" th:action="@{/order/checkout}" method="post" style="display: none;">
                        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" id="csrf-token" />
                        <div id="checkout-form-inputs"></div>
                    </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div th:replace="fragments/footer :: footer"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Store menu items data for JavaScript
        const menuItems = {
            <th:block th:each="item : ${menuItems}">
                [[${item.id}]]: {
                    id: [[${item.id}]],
                    name: '[[${#strings.escapeJavaScript(item.name)}]]',
                    price: [[${item.price}]]
                },
            </th:block>
        };

        // Update quantity input and cart
        function updateQuantity(inputId, change, event) {
            if (event) {
                event.preventDefault();
            }
            const input = document.getElementById(inputId);
            let value = parseInt(input.value) + change;
            value = Math.max(0, Math.min(20, value)); // Keep between 0 and 20
            input.value = value;
            updateCart();
            return false;
        }

        // Update cart summary
        function updateCart() {
            let total = 0;
            let hasItems = false;
            const cartItems = [];
            const formInputs = [];
            
            // Get all quantity inputs
            document.querySelectorAll('input[type="number"]').forEach(input => {
                try {
                    const quantity = parseInt(input.value) || 0;
                    if (quantity > 0) {
                        const itemId = input.id.replace('item_', '');
                        const item = menuItems[itemId];
                        if (item) {
                            const itemTotal = (item.price * quantity).toFixed(2);
                            total += parseFloat(itemTotal);
                            hasItems = true;
                            
                            // Add to cart items display
                            cartItems.push(`
                                <div class="d-flex justify-content-between mb-2">
                                    <span>${item.name} x${quantity}</span>
                                    <span>$${itemTotal}</span>
                                </div>
                            `);
                            
                            // Add hidden input for form submission
                            formInputs.push(`<input type="hidden" name="item_${itemId}" value="${quantity}">`);
                        }
                    }
                } catch (e) {
                    console.error('Error processing item:', e);
                }
            });
            
            // Update cart display
            const cartSummaryEl = document.getElementById('cart-summary');
            const cartTotalEl = document.getElementById('cart-total');
            const checkoutBtn = document.getElementById('checkout-btn');
            const formInputsEl = document.getElementById('form-inputs');
            
            if (hasItems) {
                // Update cart summary
                document.getElementById('cart-items').innerHTML = cartItems.join('');
                cartTotalEl.textContent = `$${total.toFixed(2)}`;
                
                // Update form inputs
                if (formInputsEl) {
                    formInputsEl.innerHTML = formInputs.join('');
                }
                
                checkoutBtn.disabled = false;
            } else {
                document.getElementById('cart-items').innerHTML = '<p class="text-muted">Add items to your order</p>';
                cartTotalEl.textContent = '$0.00';
                if (formInputsEl) {
                    formInputsEl.innerHTML = '';
                }
                checkoutBtn.disabled = true;
            }
        }
        
        // Handle checkout process
        function proceedToCheckout() {
            // Make sure we have items in the cart
            const hasItems = Array.from(document.querySelectorAll('input[type="number"]')).some(
                input => parseInt(input.value || 0) > 0
            );
            
            if (!hasItems) {
                window.location.href = '/order/menu?error=Please add items to your cart before checkout';
                return false;
            }
            
            // Check if user is authenticated
            fetch('/api/check-auth')
                .then(response => {
                    if (response.ok) {
                        // User is authenticated, proceed to checkout
                        prepareAndSubmitCheckoutForm();
                    } else {
                        // User is not authenticated, redirect to login with redirect URL
                        const currentUrl = window.location.pathname + (window.location.search || '');
                        window.location.href = '/login?redirect=' + encodeURIComponent(currentUrl);
                    }
                })
                .catch(error => {
                    console.error('Error checking authentication:', error);
                    const currentUrl = window.location.pathname + (window.location.search || '');
                    window.location.href = '/login?redirect=' + encodeURIComponent(currentUrl);
                });
            
            return false;
        }
        
        // Prepare and submit the checkout form
        function prepareAndSubmitCheckoutForm() {
            const formInputs = document.getElementById('form-inputs');
            const checkoutFormInputs = document.getElementById('checkout-form-inputs');
            const checkoutForm = document.getElementById('checkout-form');
            
            if (!formInputs || !checkoutFormInputs || !checkoutForm) {
                console.error('Required form elements not found');
                window.location.href = '/order/menu?error=Error processing your order. Please try again.';
                return;
            }
            
            try {
                // Copy all the form inputs to the checkout form
                checkoutFormInputs.innerHTML = formInputs.innerHTML;
                
                // Submit the checkout form
                checkoutForm.submit();
            } catch (error) {
                console.error('Error submitting checkout form:', error);
                window.location.href = '/order/menu?error=Error processing your order. Please try again.';
            }
        }
        
        // Initialize cart
        document.addEventListener('DOMContentLoaded', function() {
            // Update cart when page loads
            updateCart();
            
            // Update cart when inputs change
            document.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('change', updateCart);
                input.addEventListener('input', updateCart);
            });
            
            // Add form submission handler
            const orderForm = document.getElementById('order-form');
            if (orderForm) {
                orderForm.addEventListener('submit', handleFormSubmit);
            }
            
            // Prevent form submission on enter key
            document.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    return false;
                }
            });
        });
    </script>
</body>
</html>
